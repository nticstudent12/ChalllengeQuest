generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String              @id @default(cuid())
  email             String              @unique
  username          String              @unique
  password          String
  firstName         String?
  lastName          String?
  avatar            String?
  xp                Int                 @default(0)
  level             Int                 @default(1)
  rank              Int?
  isAdmin           Boolean             @default(false)
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  challengeProgress ChallengeProgress[]
  notifications     Notification[]
  submissions       Submission[]
  achievements      UserAchievement[]

  @@map("users")
}

model Challenge {
  id              String              @id @default(cuid())
  title           String
  description     String
  category        String
  difficulty      Difficulty
  xpReward        Int
  startDate       DateTime
  endDate         DateTime
  image           String?
  requiredLevel   Int                 @default(1)
  isActive        Boolean             @default(true)
  maxParticipants Int?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  progress        ChallengeProgress[]
  stages          Stage[]
  submissions     Submission[]

  @@map("challenges")
}

model Stage {
  id          String          @id @default(cuid())
  challengeId String
  title       String
  description String
  order       Int
  latitude    Float
  longitude   Float
  radius      Float           @default(50)
  qrCode      String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  progress    StageProgress[]
  challenge   Challenge       @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@map("stages")
}

model ChallengeProgress {
  id          String          @id @default(cuid())
  userId      String
  challengeId String
  status      ProgressStatus  @default(ACTIVE)
  startedAt   DateTime        @default(now())
  completedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  challenge   Challenge       @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  stages      StageProgress[]
  submissions Submission[]

  @@unique([userId, challengeId])
  @@map("challenge_progress")
}

model StageProgress {
  id                  String            @id @default(cuid())
  challengeProgressId String
  stageId             String
  status              StageStatus       @default(PENDING)
  completedAt         DateTime?
  latitude            Float?
  longitude           Float?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  challengeProgress   ChallengeProgress @relation(fields: [challengeProgressId], references: [id], onDelete: Cascade)
  stage               Stage             @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@unique([challengeProgressId, stageId])
  @@map("stage_progress")
}

model Submission {
  id                  String             @id @default(cuid())
  userId              String
  challengeId         String
  challengeProgressId String? // ðŸ”¥ Add this
  stageId             String?
  type                SubmissionType
  content             String
  latitude            Float?
  longitude           Float?
  isApproved          Boolean?
  reviewedBy          String?
  reviewedAt          DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  challenge           Challenge          @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeProgress   ChallengeProgress? @relation(fields: [challengeProgressId], references: [id], onDelete: Cascade)

  @@map("submissions")
}

model Achievement {
  id          String            @id @default(cuid())
  name        String            @unique
  description String
  icon        String
  xpReward    Int
  condition   String
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  users       UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  earnedAt      DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  data      String?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Leaderboard {
  id        String            @id @default(cuid())
  userId    String
  xp        Int
  rank      Int
  period    LeaderboardPeriod @default(ALL_TIME)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@unique([userId, period])
  @@map("leaderboard")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  icon        String?
  color       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("categories")
}

model Level {
  id        String   @id @default(cuid())
  number    Int      @unique
  name      String
  minXP     Int
  maxXP     Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("levels")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ProgressStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum StageStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum SubmissionType {
  TEXT
  IMAGE
  LOCATION
  QR_CODE
}

enum NotificationType {
  ACHIEVEMENT
  CHALLENGE_UPDATE
  LEADERBOARD_CHANGE
  SYSTEM
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}
